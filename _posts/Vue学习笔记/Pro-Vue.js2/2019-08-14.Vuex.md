

<!-- TOC -->

- [1. 创建 `Vuex.Store` 实例](#1-创建-vuexstore-实例)
  - [1.1. 安装 vuex](#11-安装-vuex)
  - [1.2. 创建文件](#12-创建文件)
- [2. 使用 `store`](#2-使用-store)
  - [2.1. 把 `store` 实例加入进根 Vue 实例里](#21-把-store-实例加入进根-vue-实例里)
  - [2.2. 在子组件里访问 `store`](#22-在子组件里访问-store)
    - [2.2.1. 直接引用](#221-直接引用)
    - [2.2.2. 通过映射](#222-通过映射)
    - [2.2.3. 给 getters 传参](#223-给-getters-传参)
    - [2.2.4. 接收数据改变的通知](#224-接收数据改变的通知)
- [3. Data Store 模块](#3-data-store-模块)
  - [3.1. 创建子模块](#31-创建子模块)
  - [3.2. 注册](#32-注册)
  - [3.3. 在子组件里访问子模块](#33-在子组件里访问子模块)
  - [3.4. 模块的命名空间](#34-模块的命名空间)
    - [3.4.1. 申明](#341-申明)
    - [3.4.2. 访问带有命名空间的子模块](#342-访问带有命名空间的子模块)

<!-- /TOC -->

---

### 1. 创建 `Vuex.Store` 实例

#### 1.1. 安装 vuex

`npm install vuex`

#### 1.2. 创建文件

src/store/index.js :

```js
import Vue from "vue";
import Vuex from "vuex";
Vue.use(Vuex); // vuex 是一个 vue 插件
export default new Vuex.Store({
  strict: true, // 禁止子组件直接访问和修改 state
  state: { // 保存应用程序级别的数据
    sProducts: [...],
  },
  mutations: { // 执行同步操作
    muSaveProduct(currentState, optionalArgs) {...},
  },
  getters: { // 提供类似 computed 的计算属性
    gFilteredProducts(state, getters) {...}
  },
  actions: { // 执行异步操作（方法内部通过 mutations 把异步执行的结果同步到 store 里）
    async aGetProductsAction(context, optionalArgs) { // context ≈ $store
      (await Axios.get(baseUrl)).data.forEach(p => context.commit("saveProduct", p));
    }
  }
});
```

### 2. 使用 `store`

#### 2.1. 把 `store` 实例加入进根 Vue 实例里

```js
import store from './store'

new Vue({
  ...
  store, // 等价于：store: store
  ...
});
```

#### 2.2. 在子组件里访问 `store`

###### 2.2.1. 直接引用

```js
export default {
  computed: {
    cProducts() {
      return this.$store.state.products; // 通过 $store.state直接访问各个数据
    },
    cFilteredProducts() {
      return this.$store.getters.gFilteredProducts; // 通过 $store.getters 直接访问各个 getter
    },
  },
  methods: {
    deleteProduct(product) {
      this.$store.commit("deleteProduct", product); // 通过 $store.commit 方法调用它的 mutations
    },
  },
  created() {
    this.$store.dispatch("getProductsAction"); // 通过 $store.dispatch 方法触发它的 actions
  },
};
```

###### 2.2.2. 通过映射

```js
import { mapState, mapGetters, mapMutations, mapActions } from "vuex";

export default {
  computed: {
    ...mapState(["products"]),// 更多方式：https://vuex.vuejs.org/guide/state.html#the-mapstate-helper
    ...mapGetters([...]) // 更多方式：https://vuex.vuejs.org/guide/getters.html#the-mapgetters-helper
  },
  methods: {
    ...mapMutations({ // 更多方式：https://vuex.vuejs.org/guide/mutations.html#committing-mutations-in-components
      editProduct: "selectProduct",
    }), 
    ...mapActions({ // 更多方式：https://vuex.vuejs.org/guide/actions.html#dispatching-actions-in-components
      getProducts: "getProductsAction",
    })
  },
  created() {
    this.getProducts();
  }
}
```

###### 2.2.3. 给 getters 传参

```js
...
// store
getters: {
  filteredProducts(state, getters) {
    return (amount) => getters.orderedProducts.filter(p => p.price > amount);
  }
}
...

...
// 子组件
computed: {
  products() {
    return this.$store.getters.filteredProducts(175);
  }
}
...
```

###### 2.2.4. 接收数据改变的通知

```js
// 子组件
created() {
this.$store.watch(
        state => state.selectedProduct, // 箭头函数，返回要监听的数据
        (newValue, oldValue) => {...}); // 数据变化时的回调函数
}
```

>`<button class="btn btn-primary" v-on:click="MappedMethod">`
>
>等价于：
>
>`<button class="btn btn-primary" v-on:click="MappedMethod($event)">`
>
>所以如果想要调用 store 的方法，但是不提供参数，得要这样做：
>
>`<button class="btn btn-primary" v-on:click="MappedMethod()">`
{.note}

### 3. Data Store 模块

#### 3.1. 创建子模块

创建文件： src/store/sub-store-module.js

```js
export default {
  state: {...},
  getters: {
    gGetAA(state, getters, rootState) {}
  },
  mutations: {
    muChangeAA(state, optionalArgs) {}
  },
  actions: {
    aGetRemoteBB( context ) // {state, commit, rootState} = context
    {}
  }
}
```

#### 3.2. 注册

```js
...
import mySub from './sub-store-module'

export default new Vuex.Store({
  modules: {
    mySub
  }
}
...
```

#### 3.3. 在子组件里访问子模块

```js
import { mapState, mapGetters, mapMutations, mapActions } from "vuex";

export default {
  computed: {
    ...mapState({
      // 除了访问 state 要加上 mySub 前缀之外， 访问 getter mutations actions 和使用 root state 一样
      cAA: state => state.mySub.sAA
    }),
    ...mapGetters({
      cBB: 'gBB' // 与访问 root state 一样
    })
  },
  methods: {
    ...mapMutations({
      editProduct: "selectProduct", // 与访问 root state 一样
    }), 
    ...mapActions({
      getProducts: "getProductsAction", // 与访问 root state 一样
    })
  }
}
```

#### 3.4. 模块的命名空间

###### 3.4.1. 申明

```js
// 子模块.js
export default {
  namespaced: true
  ...
}
```

###### 3.4.2. 访问带有命名空间的子模块

```js
import { mapState, mapGetters, mapMutations, mapActions } from "vuex";

export default {
  computed: {
    ...mapState({
      cAA: state => state.mySub.sAA
    }),
    ...mapGetters({
      cBB: 'mySub/gBB' // 加上 mySub 前缀
    })
  },
  methods: {
    ...mapMutations({
      editProduct: "mySub/selectProduct", // 加上 mySub 前缀
    }), 
    ...mapActions({
      getProducts: "mySub/getProductsAction", // 加上 mySub 前缀
    })
  }
}
```